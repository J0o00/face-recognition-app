{% extends "layout.html" %}
{% block title %}Register New Student{% endblock %}
{% block content %}
<div class="bg-white p-8 rounded-2xl shadow-lg">
    <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">Register a New Student</h2>
    <form id="register-form" method="post" class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <!-- Left Side: Form Fields -->
        <div>
            <div class="mb-4">
                <label for="name" class="block text-gray-700 text-sm font-bold mb-2">Student Name</label>
                <input type="text" id="name" name="name"
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required>
            </div>
            <div class="mb-6">
                <label for="class" class="block text-gray-700 text-sm font-bold mb-2">Class (e.g., S5 EEE)</label>
                <input type="text" id="class" name="class"
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required>
            </div>
            <!-- Hidden fields for image data -->
            <input type="hidden" name="image1" id="image1">
            <input type="hidden" name="image2" id="image2">
            <input type="hidden" name="image3" id="image3">

            <button type="submit" id="submit-btn"
                class="w-full bg-blue-500 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:shadow-outline disabled:bg-gray-400">
                Register Student
            </button>
        </div>

        <!-- Right Side: Camera and Photo Capture -->
        <div>
            <div class="relative w-full aspect-video bg-gray-200 rounded-xl overflow-hidden mb-4">
                <video id="video" class="w-full h-full object-cover" style="transform: scaleX(-1);" autoplay
                    playsinline></video>
                <div id="status"
                    class="absolute bottom-2 left-2 bg-black bg-opacity-50 text-white text-sm px-2 py-1 rounded">
                    Initializing...</div>
            </div>
            <button type="button" id="capture-btn"
                class="w-full bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg mb-4 disabled:bg-gray-400">
                Capture Photo (<span id="capture-count">0</span>/3)
            </button>
            <div class="grid grid-cols-3 gap-2" id="photo-previews">
                <!-- Photo previews will be added here -->
            </div>
        </div>
    </form>
    <canvas id="canvas" class="hidden"></canvas>
</div>

<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const captureBtn = document.getElementById('capture-btn');
    const submitBtn = document.getElementById('submit-btn');
    const captureCountSpan = document.getElementById('capture-count');
    const photoPreviews = document.getElementById('photo-previews');
    const statusDiv = document.getElementById('status');
    const form = document.getElementById('register-form');

    let capturedPhotos = [];

    // Initialize state
    submitBtn.disabled = true;

    async function setupCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;
            statusDiv.textContent = 'Camera Ready';
        } catch (err) {
            statusDiv.textContent = 'Camera Error!';
            alert('Could not access camera. Please allow permissions.');
        }
    }

    captureBtn.addEventListener('click', () => {
        if (capturedPhotos.length >= 3) return;

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const context = canvas.getContext('2d');
        context.translate(canvas.width, 0);
        context.scale(-1, 1);
        context.drawImage(video, 0, 0, canvas.width, canvas.height);

        const dataUrl = canvas.toDataURL('image/jpeg');
        capturedPhotos.push(dataUrl);

        // Update UI
        updatePhotoPreviews();
        captureCountSpan.textContent = capturedPhotos.length;

        if (capturedPhotos.length === 3) {
            captureBtn.disabled = true;
            captureBtn.textContent = 'All photos captured!';
            submitBtn.disabled = false;
        }
    });

    function updatePhotoPreviews() {
        photoPreviews.innerHTML = '';
        capturedPhotos.forEach(dataUrl => {
            const img = document.createElement('img');
            img.src = dataUrl;
            img.className = 'w-full h-auto rounded-md border-2 border-green-500';
            photoPreviews.appendChild(img);
        });
    }

    form.addEventListener('submit', (e) => {
        if (capturedPhotos.length < 3) {
            e.preventDefault();
            alert('You must capture 3 photos before registering.');
            return;
        }
        document.getElementById('image1').value = capturedPhotos[0];
        document.getElementById('image2').value = capturedPhotos[1];
        document.getElementById('image3').value = capturedPhotos[2];
    });

    setupCamera();
</script>
{% endblock %}